<!DOCTYPE haml>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.dev.js"></script>
<link href="tree.css" type="text/css" rel="stylesheet">
<title>A Tree</title>
<script>

function isCollapsed( n ) {
    return ! n.classList.contains("active");
}

function gather(l, n) {
  var cc  = n.childNodes;
  var len = cc.length, i;
  //console.log("Gather " + cc.length + " nodes");
  for ( i = 0; i < len; i++ ) {
	  if ( cc[i].nodeType == 1 ) {
		  // ELEMENT
		  if ( cc[i].classList.contains("leaf") ) {
              if ( ! cc[i].classList.contains("WO") ) {
			      l.push( cc[i] );
              }
		  } else if ( cc[i].className !== "nested" || ! isCollapsed( cc[i] ) ) {
			  gather( l, cc[i] );
		  }
	  }
  }
}

function findUpDir( nod ) {
	var par = nod.parentNode;
	while ( ! par.classList.contains("dir") ) {
		par = par.parentNode;
	}
	if ( par.id == "theTreeTop" ) {
		return null;
	}
	return par;
}

function assemblePath( nod ) {
	var l  = [];
	var up = findUpDir( nod );
	l.push( nod.innerText );
	while ( up != null ) {
		nod = up.querySelector("span.caret");
		l.push( nod.innerText );
		up = findUpDir( up );
	}
    l.push("");
	return l.reverse().join('/');
}

function bpress() {
var l = [], i;
  gather(l, document.body);
  for (i=0; i<l.length; i++ ) {
    console.log( l[i] );
  }
}

function getNested(el) {
    return el.parentElement.querySelector(".nested");
}

function id2Numeric(id) {
	return parseInt(id.match("[0-9]+")[0]);
}

function changeSubscription(subs, nod) {

	var l   = [];
	var cmd;

	gather(l, nod);

	if ( l.length > 0 ) {
		var i;

		var lid = new Array( l.length );

		if ( subs ) {
			for (i=0; i<l.length; i++ ) {
				l[i].value = "";
				lid[i] = id2Numeric(l[i].id);
			}
			cmd = "subscribe";
		} else {
			for (i=0; i<l.length; i++ ) {
				lid[i] = id2Numeric(l[i].id);
			}
			cmd = "unsubscribe";
		}

/* FIXME - delete eventually
		var dict = {};
		dict[cmd] = lid;
 */

		window.treeSocket.emit(cmd, JSON.stringify( lid ) );
	}
}

function toggleCaret() {
	var nn = getNested( this );
    var cmd;
	if ( nn.classList.contains("active") ) {
		localStorage.removeItem("active_"+nn.id);
        cmd = false;
	} else {
		localStorage.setItem("active_"+nn.id,"true");
        cmd = true;
	}
	nn.classList.toggle("active");
	this.classList.toggle("caret-down");

	changeSubscription( cmd, nn );
}

function isHexFmt( el ) {
	var chkboxes = el.parentElement.parentElement.getElementsByClassName("hexFmt");
    if ( chkboxes.length > 0 && chkboxes[0].checked ) {
		return true;
	}
	return false;
}

function updateVal_1(el, isHex, val)
{
	if ( val != val ) {
		// bail if NAN
		return;	
	}
	if ( isHex ) {
		el.value = "0x" + val.toString(16);
	} else {
		el.value = val;
	}
}

function updateVal( el ) {
	if ( typeof(el.cachedValue) != "undefined" ) {
		updateVal_1( el, isHexFmt( el ), el.cachedValue );
	}
}

function flipHex( chkbox ) {
	var txt = chkbox.parentElement.parentElement.getElementsByClassName("int")[0];
	var val = parseInt( txt.value, 0 );

	updateVal_1( txt, chkbox.checked, val );
}

function storeHex( chkbox ) {
	if ( chkbox.checked != chkbox.classList.contains("checked") ) {
		localStorage.setItem( "checked_" + chkbox.id, chkbox.checked );
console.log("storing hex " + chkbox.id + ": " + chkbox.checked);
	} else {
		localStorage.removeItem( "checked_" + chkbox.id );
console.log("deleting hex " + chkbox.id);
	}
}

function restoreHex( chkbox ) {
	var val = localStorage.getItem( "checked_" + chkbox.id );
console.log("restoring hex " + chkbox.id + ": " + val);
	if ( val != null ) {
		chkbox.checked = (val.toLowerCase() == 'true');
	}
}


function connectEvents() {

    console.log(document.domain);
    console.log(location.port);

	var toggler = document.getElementsByClassName("caret");

	var i;
	for (i = 0; i < toggler.length; i++) {

		var nn = getNested(toggler[i]); 
		if ( "true" == localStorage.getItem("active_"+nn.id) ) {
			nn.classList.toggle("active"); 
			toggler[i].classList.toggle("caret-down");
		}

	}

	var checkboxes = document.getElementsByClassName("hexFmt");
	for ( i=0; i < checkboxes.length; i++ ) {
		restoreHex( checkboxes[i] );
	}

	window.treeSocket = new io();


	window.treeSocket.on('connect', function() {
		changeSubscription(true, document.body);
	});

	window.treeSocket.on('disconnect', function() {
		console.error('Chat socket closed unexpectedly');
		var l = [], i;
		gather(l, document.body);
		for (i=0; i<l.length; i++ ) {
			var el = document.getElementById( l[i].id );
			el.value = "";
		}
	});

    window.treeSocket.on('update', function(data) {
        var dd = JSON.parse( data );
        for (i=0; i<dd.length; i++) {
			var el = document.getElementById( dd[i][0] );
            el.cachedValue = dd[i][1];
			if ( document.activeElement != el ) {
				updateVal( el );
			}
		}
    });

	$(document).on("change","input.leaf,select.leaf",function() {

        var v = this.value;

		if ( this.classList.contains("int") ) {
			v = parseInt( this.value, 0 );			

			if ( v != v ) {
				alert( "Invalid Numerical Entry (integer)" );
				if ( typeof( this.cachedValue ) != "undefined" ) {
					this.value = this.cachedValue;
				}
				return;
			}
		} else if ( this.classList.contains("float") ) {
			v = parseFloat( this.value );			

			if ( v != v ) {
				alert( "Invalid Numerical Entry (float)" );
				if ( typeof( this.cachedValue ) != "undefined" ) {
					this.value = this.cachedValue;
				}
				return;
			}
		}
		// So this goes into the readback when blurred
		this.cachedValue = v;
		var l = [];
		var p = [];
		p.push( id2Numeric( this.id ) );
		p.push( v                     );
		l.push( p                     );
		window.treeSocket.emit( "setVal", JSON.stringify( l ) );
		if ( isHexFmt( this ) ) {
			updateVal_1( this, true, v );
		}
	});

	$(document).on("change", ".hexFmt", function() {
		flipHex ( this );
		storeHex( this );
	});

	$(document).on("click", ".caret", toggleCaret);

	$(document).on("click", "button.cmd", function() {
		window.treeSocket.emit( "setVal", "[ [ " + id2Numeric( this.id ) + ", 1 ] ]" );
	});

	$(document).on("blur",  ".leaf", function() {
		if ( typeof(this.cachedValue) != "undefined" ) {
			updateVal( this );
		}
	});

	$(document).on("mouseover", ".hexFmt",
		function() {
			console.log("OVER");
			if ( typeof(this.tooltipTimer) != "undefined" && this.tooltipTimer ) {
				clearTimeout( this.tooltipTimer );
				this.tooltipTimer = null;
			}
			var tip = this.parentNode.getElementsByClassName("tooltip")[0];
			this.tooltipTimer = setTimeout( function( tip ) {
					console.log("TIMEOUT: " + tip);
					if ( ! tip.classList.contains("show") ) {
						tip.classList.add("show")
					}
			}, 2000, tip);
			console.log("set timeout: " + this.tooltipTimer);
	});
	$(document).on("mouseout", ".hexFmt",
		function() {
			var tip = this.parentNode.getElementsByClassName("tooltip")[0];
			var timer = this.tooltipTimer;
			if ( timer ) {
				clearTimeout( timer );
				this.tooltipTimer = null;
			}
			tip.classList.remove("show");
	});

	console.log("Events CONNECTED");
}

</script>
</head>
<body>
<ul id="theTreeTop" class="dir"> {% block content %}<div id="content">{% endblock %}</div> </ul> 
<button type="button" onclick=bpress()>PRESS</button>

<script>
//$("#content").load("guts.html", connectEvents);
$(connectEvents);
</script>

</body>
</html>
